<html>

    <head>
	<meta charset="utf-8">
	<link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
	<!--<link href="/twitter-bootstrap/twitter-bootstrap-v2/docs/assets/css/bootstrap.css" rel="stylesheet">-->
	
        <!--<script src="/twitter-bootstrap/twitter-bootstrap-v2/js/bootstrap-tooltip.js"></script>  -->
        <!--<script src="/twitter-bootstrap/twitter-bootstrap-v2/js/bootstrap-popover.js"></script>-->
		
	<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
	
	<!--<link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.2/css/bootstrap-combined.min.css" rel="stylesheet">-->
	
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.37/css/bootstrap-datetimepicker.min.css" />
     
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.6/moment.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery.transit/0.9.12/jquery.transit.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery.collapsible/1.2/jquery.collapsible.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.5/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.37/js/bootstrap-datetimepicker.min.js"></script>
	
    </head>

    {% load bootstrap3 %}
    {% bootstrap_css %}
    {% bootstrap_javascript %} 
    {% bootstrap_icon "info" %}
    
    <script>
	function intersectionChanged() {
	    document.getElementById("refreshTypeId").value = "RefreshData";
	    document.getElementById("locationFormId").submit();
	}
	
	function signalChanged() {
	    document.getElementById("refreshTypeId").value = "RefreshData";
	    document.getElementById("locationFormId").submit();
	}
	
	function alertEmptyList(){
	    alert("")    
	}
    
	function submitToPlot() {
	    document.getElementById("refreshTypeId").value = "Plot";
	    document.getElementById("locationFormId").submit();	
	}
	
	function performanceChanged() {
	    //get html element (here is the select), by id, id is in element's <>
	    var selectedPerformance = document.getElementById("performanceSelectionId").value;
	    
	    var detectorNotNeededArray = ["Green_duration","Percent_of_green_duration","Active_green","Saturation_flow_rate"];
	    var detectorHidden = (detectorNotNeededArray.indexOf(selectedPerformance) > -1);
	    
	    if (detectorHidden) {
		//get detector label by its id and change delector style, by change display to none or block (means hide or show)
		document.getElementById('detectorLabelId').style.display = "none";
		document.getElementById('detectorSelectionId').style.display = "none";
	    }
	    else {
		document.getElementById('detectorLabelId').style.display = "block";
		document.getElementById('detectorSelectionId').style.display = "block";
	    }
	    
	    var signalGroupNotNeededArray = ["Green_duration","Percent_of_green_duration"];
	    var signalGroupHidden = (signalGroupNotNeededArray.indexOf(selectedPerformance) > -1);
	    
	    if (signalGroupHidden) {
	        document.getElementById('signalGroupLabelId').style.display = "none";
	        document.getElementById('signalGroupSelectionId').style.display = "none";
	    }
	    else { 
		document.getElementById('signalGroupLabelId').style.display = "block";
	        document.getElementById('signalGroupSelectionId').style.display = "block";
	    }
	    
	    var timeIntervalNotNeededArray = ["Green_duration","Percent_of_green_duration","Active_green","Queue_length","Saturation_flow_rate"];
	    var timeIntervalHidden = (timeIntervalNotNeededArray.indexOf(selectedPerformance) > -1);
	    
	    if(timeIntervalHidden) {
	        document.getElementById('timeIntervalLabelId').style.display = "none" ;
		document.getElementById('timeIntervalSelectionId').style.display = "none";
	    }
	    else{
	        document.getElementById('timeIntervalLabelId').style.display = "block";
		document.getElementById('timeIntervalSelectionId').style.display = "block";
	    }
	    
	}
	
	function showLocationMap() {
	    var selectedLocationForMap = document.getElementById("intersectionSelectionId").value;
	    document.getElementById('selectedLocatioForMapId').value = selectedLocationForMap;
	    document.getElementById("showMapFormId").submit();	
	}
	
    </script>
    <script>  
        $(function ()  {
	    $("#timezonetip").popover();  
        });  
    </script> 
    <script>
        $(document).ready(function(){
            $('[data-toggle="popover"]').popover();   
	});
    </script>
    
    
    <script type="text/javascript">
	$(function () {
	    $('#datetimepicker1').datetimepicker({
		format: 'DD/MM/YYYY HH:mm'
	    });
	    $('#datetimepicker2').datetimepicker({
		format: 'DD/MM/YYYY HH:mm',
		useCurrent: false
	    });	
	    $("#datetimepicker1").on("dp.change", function (e) {
		$('#datetimepicker2').data("DateTimePicker").minDate(e.date);
	    });
	    $("#datetimepicker2").on("dp.change", function (e) {
		$('#datetimepicker1').data("DateTimePicker").maxDate(e.date);
	    });		
	});
    </script>
    
    <body onload="performanceChanged()">
    {# Navigate bar and a header #}
    <nav id="myNavbar" class="navbar navbar-default navbar-inverse navbar-fixed-top" role="navigation">
	<!-- Brand and toggle get grouped for better mobile display -->
	<div class="container-fluid">
	    <div class="navbar-header">
		<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbarCollapse">
		    <span class="sr-only">Toggle navigation</span>
		    <span class="icon-bar"></span>
		    <span class="icon-bar"></span>
		    <span class="icon-bar"></span>
		</button>
		<a class="navbar-brand" href="#">Imanalyst</a>
	    </div>
	    <!-- Collect the nav links, forms, and other content for toggling -->
	    <div class="collapse navbar-collapse" id="navbarCollapse">
		<ul class="nav navbar-nav">
		    <!--<li class="active"><a href="http://www.tutorialrepublic.com" target="_blank">Instruction</a></li>-->
		    <li><a href="http://www.peekfinland.fi/" target="_blank">About</a></li>
		    <li><a href="http://imtech.com/EN/Contacts-Nordic.html" target="_blank">Contact</a></li>
		</ul>
	    </div>
	</div>
    </nav>
    
    <div class="jumbotron">
	<div class="container-fluid">
	    <h1>Traffic Signal Analysis</h1>
	</div>
    </div>
    
    {# Menu #}
    <div class="row">
    <div class="col-sm-1 " ></div>
    <div class="col-sm-3 " >
    
    <form id="showMapFormId" method="POST" type="hidden" action="{% url 'traffic:maps' %}" target="_blank">{% csrf_token %}
	<input id="selectedLocatioForMapId" type="hidden" name="selectedLocatioForMap" value="">
    </form>
     
    <form id="locationFormId" method="POST" action="{% url 'traffic:index'%}">{% csrf_token %}
        
        {# Select performance #}
    
	<label for="performance">Performance measure </label> 
	<a href="{% url 'traffic:measuresinfo' %}"> 
	<i class='glyphicon glyphicon-book'></i></a>
	<a href="#" id="timezonetip"  data-toggle="popover" data-trigger="hover" title="" data-content="Saturation flow rate is the number of vehicles being able to cross the stop line;
	Green duration is green timing length per cycle for all signal groups; Queue length estimates the length of queue; Active green count the percent of active and passive green;
	Maximum capacity calculates the amount of vehicle being able to cross during total green time in a period; Arrival on green is on how many vehicles pass the stop line duration green timing;
	Volume counts the amount of vehicles passing over in a period." >
	<i class='glyphicon glyphicon-info-sign'></i>
	</a>   
	
	{# onchange means when select option is changed, we will call function performanceChanged() in javascript #}
	<select id="performanceSelectionId" name ="performance" class="form-control" onchange="performanceChanged()">
	    {% for measure in measuresList %}
		{% if measure == selectedPerformance %}
		    <option value= {{measure}} selected="selected"> {{measure}} </option> 
		{% else %}
		    <option value= {{measure}}> {{measure}} </option> 
		{% endif %}
	    {% endfor %}
	    performanceChanged()
	</select>
			
	{# Select intersection #}
	<p>
	<label for="location">Intersection </label>
	<select id="intersectionSelectionId" name="location" onchange="intersectionChanged()" class="form-control">
	{% for locationName in locationNameList %}
	    {% if locationName == selectedLocation %}
		<option value= {{locationName}} selected="selected"> {{locationName}} </option> 
	    {% else %}
		<option value= {{locationName}}> {{locationName}} </option> 
	    {% endif %}
	{% endfor %}
	</select> 
	</p>
	
        <p>  
	<button type="button" class="btn btn-info" onclick="showLocationMap()">map</button>
	</p>
	
	{# Selct signalGroup #}
	{% if not sgNameList  %}
	    <p> Sorry, there is no valid signalGroup configuration data in the selected intersection. Please choose other intersections. </p>
	{% else %}
	    <p>
	    <label id="signalGroupLabelId" for="signalGroup">Signal group</label>
	    
	    <select id="signalGroupSelectionId" name="signalGroup" onchange="signalChanged()" class="form-control">
		{% for signalGroup in sgNameList %}
		    {% if signalGroup == selectedSgName %}
			<option value = {{signalGroup}} selected="selected">{{signalGroup}} </option>
		    {% else %}
			<option value = {{signalGroup}}> {{signalGroup}} </option>
		    {% endif %}
		{% endfor %}
	    </select>
	{% endif %}
	</p>
	
	
	{# Selct detector #}
	{% if sgNameList  %}
	    <p>
	    {% if not detectorList  %}
		<p> Sorry, there is no valid detector configuration data in the selected signal group. Please choose other signal group. </p>
	    {% else %}
		<label id="detectorLabelId" for="detector">Detector</label>
		<select id="detectorSelectionId" name ="detector" class="form-control" >
		{% for detector in detectorList %}
		    {% if detector == selectedDetector %}
		        <option value ={{detector}} selected="selected">{{detector}}</option>
		    {% else %}
		        <option value = {{detector}}>{{detector}}</option>
		    {% endif %} 
		{% endfor %}
		</select> 
	    {% endif %}
	    </p>
	{% endif %}
	
	{# multiple select detectors #}
	<label> Multiple choice of detectors </label>
	{% if sgNameList %}
	    <p>
	    <select id = "detectorMultipleSelectionID" name = "detectors" class="form-control" multiple ="multiple" size ="5">
		{% for detector in detectorListInSelectedLocation %}
		
                    {% if detector in selectedDetectorList %} 
			<option value = {{detector}} selected="selected">{{detector}}</option>
		    {% else %}
		        <option value ={{detector}}> {{detector}} </option>
		    {% endif %}

		{% endfor %}
	    
	    </select> 
	    </p>
	{% endif %}
	
	{# Select timeInterval #}
	<label id = "timeIntervalLabelId" for="timeInterval"> Time interval (minutes) </label>
	<select id="timeIntervalSelectionId" name="timeInterval" class="form-control" >
	{% for timeInterval in timeIntervalList%}
	    {% if timeInterval = selectedTimeInterval %}
	        <option value = {{timeInterval}} selected="selected">{{timeInterval}}</option>
	    {% else %}
	        <option value = {{timeInterval}}> {{timeInterval}} </option>
	    {% endif %}
	{% endfor %}
	
	</select>
	                
	{#select datatime #}
	<br>
	<div class="form-group">
	    <label> Start datetime </label>
		<div class='input-group date' id='datetimepicker1'> 
		{% if startTimeString %}
		    <input type='text' class="form-control" name="starttime" value={{startTimeString}}/>
		{% else %}
		    <input type='text' class="form-control" name="starttime" value="2015-07-10T18:00:00"/>
		{% endif %}
		    <span class="input-group-addon">
			<span class="glyphicon glyphicon-calendar"></span>
		    </span>
		</div>
	</div>
	<div class="form-group">
	    <label> End datetime </label>
		<div class='input-group date' id='datetimepicker2'>
		    <input type='text' class="form-control" name="endtime" value={{endTimeString}} />
		    <span class="input-group-addon">
			<span class="glyphicon glyphicon-calendar"></span>
		    </span>
		</div>
	</div> 
	
    
	<!--<p> <label> Start datetime </label>-->
	    <!--{% if startTimeString %}-->
		<!--<input type="datetime-local" name="starttime" value={{startTimeString}}> -->
	    <!--{% else %}-->
		<!--<input type="datetime-local" name="starttime" value="2015-07-10T18:00:00"> </p>-->
	    <!--{% endif %}-->
	<!--</p>	-->
	
	<!--<p><label> End datetime </label>-->
	<!--{% if endTimeString %}-->
	    <!--{% if endTimeString > startTimeString %}-->
	        <!--<input type="datetime-local" name="endtime" value={{endTimeString}}{{endTimeString|time:"H:i"}}> </p>-->
	    <!--{% else %}-->
	        <!--<input type="datetime-local" name="endtime" value="2015-07-10T19:00:00"></p>-->
		
	        <!--<div class="alert alert-danger" role="alert">-->
                  <!--<span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>-->
                  <!--<span class="sr-only">Error:</span>-->
                   <!--Enter end time later then start time -->
		<!--</div>-->
	    <!--{% endif %}-->
	<!--{% else %}-->
	    <!--<input type="datetime-local" name="endtime" value="2015-07-10T19:00:00"></p>-->
	<!--{% endif %}-->
	
	
	<p>
	<a href="#" id="timezonetip"  data-toggle="popover" data-trigger="hover" title="" data-content="Please use timezone Europe/Helsinki" >
	<i class='glyphicon glyphicon-info-sign'></i>
	</a>   
	</p>
	<!--<p>Date: <input type="text" name="startdate" id="datepicker"></p>-->
	
	
	{# submit button #}
	<br>
	<button onclick="submitToPlot()" class="btn btn-primary">
	{% bootstrap_icon "star" %} Submit
	</button>
	
	<input id="refreshTypeId" type="hidden" name="refreshType" value="">
	
    </form>
    </div>
    
    {# Plot result #}
    <div class="col-sm-6">
	{% load staticfiles %}
	<img src="data:image/png;base64,{{ image }}">    
	<br></br>
	Analysis result <a href="{% static "traffic/result.csv" %}">Download CSV File</a>   

    </div>
    </div>
    
    <div class="row">
    <div class="col-sm-4">
    </div>
    
    {# show csv file of result #}
    <div class="col-sm-5">
    {% load staticfiles %}
    <iframe style = "width:600px;" src="{% static "traffic/result.txt" %}"></iframe> 
    </div>
    </div>
    <br>
    
    {# display the map of the intersection #}
    <div class="row">
	<div class="col-sm-8">
	{% load staticfiles %}
	<img src="{% static "traffic/"|add:selectedLocation|add:".png" %}">
	</div>
    </div>
    
    </body>
</html>